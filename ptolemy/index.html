<!DOCTYPE html>
<html>
  <head>
    <script src="jquery-1.8.0.min.js" type="text/javascript"></script>
    <script>
	window.onload = function() {
		// Load the JSON document
		$.getJSON('Features.js', function(data) {
			var mapCanvas = document.getElementById('map');
			var mapContext = mapCanvas.getContext('2d');
			var image = new Image();
			var list = document.getElementById('list');

			// Crop & rotate image on load
			image.onload = function() {
				mapCanvas.width = image.width;
				mapCanvas.height = image.height;
				mapContext.drawImage(image, 0, 0);
				
				for(var i = 0; i < data.length; i++) {
					var container = document.createElement('div');
					var canvas = document.createElement('canvas');
					var label = document.createElement('h2');
					label.setAttribute('id', i);
					label.innerHTML = '#' + i;
					container.appendChild(label);
					container.appendChild(canvas);
					list.appendChild(container);
					
					var feature = data[i];
					var x0 = feature.corners[0].x;
					var y0 = feature.corners[0].y;
					var x1 = feature.corners[1].x;
					var y1 = feature.corners[1].y;
					var x2 = feature.corners[2].x;
					var y2 = feature.corners[2].y;
					var width = Math.sqrt((x1-x0)*(x1-x0) + (y1-y0)*(y1-y0));
					var height = Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
					if(width < height) {
						var temp = width;
						width = height;
						height = temp;
					}
					var angle = feature.angle > 90 ? feature.angle - 180 : feature.angle;

					canvas.width = width;
					canvas.height = height;
					
					var xmin = image.width;
					var ymin = image.height;
					var xmax = 0;
					var ymax = 0;
					for(var j = 0; j < feature.corners.length; j++) {
						xmin = Math.min(xmin, feature.corners[j].x);
						ymin = Math.min(ymin, feature.corners[j].y);
						xmax = Math.max(xmax, feature.corners[j].x);
						ymax = Math.max(ymax, feature.corners[j].y);
					}
					xmin = Math.max(xmin, 0);
					ymin = Math.max(ymin, 0);
					xmax = Math.min(xmax, image.width);
					ymax = Math.min(ymax, image.height);
					var widthRect = xmax - xmin;
					var heightRect = ymax - ymin;

					var context = canvas.getContext('2d');
					
					context.translate(width/2, height/2);
					context.rotate(-angle*Math.PI/180);
					context.translate(-widthRect/2, -heightRect/2);
					
					context.drawImage(image,
					  xmin, ymin, widthRect, heightRect, // Source clip rectangle
					  0, 0, widthRect, heightRect);     // Destination rectangle
					
					var corner = feature.corners[0];
					mapContext.beginPath();
					mapContext.moveTo(corner.x, corner.y);
					for(var j = feature.corners.length - 1; j >= 0; j--) {
						corner = feature.corners[j];
						mapContext.lineTo(corner.x, corner.y);
					}
					mapContext.lineWidth = 0.5;
					//mapContext.strokeStyle = "#888888";
					mapContext.stroke();
				}
			}
			image.src = 'British Isles.png';
			
			//add links to the map
			var inside;
			var hovered = -1;
			mapCanvas.addEventListener("mousemove", function(event) {
				var cursor = "";
				hovered = -1;
				for(var i = 0; i < data.length; i++) {
					var feature = data[i];
					var xmin = image.width;
					var ymin = image.height;
					var xmax = 0;
					var ymax = 0;
					for(var j = 0; j < feature.corners.length; j++) {
						xmin = Math.min(xmin, feature.corners[j].x);
						ymin = Math.min(ymin, feature.corners[j].y);
						xmax = Math.max(xmax, feature.corners[j].x);
						ymax = Math.max(ymax, feature.corners[j].y);
					}
					xmin = Math.max(xmin, 0);
					ymin = Math.max(ymin, 0);
					xmax = Math.min(xmax, image.width);
					ymax = Math.min(ymax, image.height);
					
					var x = event.layerX - mapCanvas.offsetLeft;
					var y = event.layerY - mapCanvas.offsetTop;
					
					if(x >= xmin && x <= xmax &&
						y >= ymin && y <= ymax){
						cursor = "pointer";
						hovered = i;
					}
				}
				document.body.style.cursor = cursor;
			}, false);
			mapCanvas.addEventListener("click", function(event) {
				if (hovered != -1)  {
					window.location = '#'+hovered;
				}
			}, false);
        });
	}
    </script>
  </head>
  <body>
    <h1>Original<h1>
    <canvas id="map"></canvas>

    <h1>Cropped &amp; Rotated</h1>
	<div id="list"></div>
  </body>
</html>