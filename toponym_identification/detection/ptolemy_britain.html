<!DOCTYPE html>
<html>
  <head>
    <title>Ptolemaic Map of the British Isles</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="../js/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script>
   var image = new Image();

  function getSize(feature, padding) {
    var x0 = feature.corners[0].x;
    var y0 = feature.corners[0].y;
    var x1 = feature.corners[1].x;
    var y1 = feature.corners[1].y;
    var x2 = feature.corners[2].x;
    var y2 = feature.corners[2].y;
			
    var dim0 = Math.sqrt((x1-x0)*(x1-x0) + (y1-y0)*(y1-y0)) + 2 * padding;
    var dim1 = Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2)) + 2 * padding;
			
    if (dim0 < dim1) {
      return {width: dim1, height: dim0};
    } else {
      return {width: dim0, height: dim1};
    }
  }		

  function openPopup(anchor, feature) {
    var padding = 5;

    var popup = document.createElement('div');
    popup.style.position = 'absolute';
    popup.style.left = (anchor.x + 5) + 'px';
    popup.style.top = (anchor.y + 5) + 'px';
    popup.setAttribute('class', 'popup');

    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');

    var size = getSize(feature, padding);
    var width = size.width;
    var height = size.height;
			
    var angle = feature.angle > 90 ? feature.angle - 180 : feature.angle;

    var bbox = getBoundingBox(feature, padding);
    var widthRect = bbox[1].x - bbox[0].x;
    var heightRect = bbox[1].y - bbox[0].y;

    canvas.width = width * 2;
    canvas.height = height * 2;
			
    context.scale(2, 2);
    context.translate(width/2, height/2);
    context.rotate(-angle*Math.PI/180);  
    context.translate(-widthRect/2, -heightRect/2);
			
    context.drawImage(image,
                      bbox[0].x, bbox[0].y, widthRect, heightRect, // Source clip rectangle
                      0, 0, widthRect, heightRect);     // Destination rectangle

    popup.appendChild(canvas);
    document.body.appendChild(popup);
    return popup;
  }

  function getBoundingBox(feature, padding) {
    var xmin = image.width;
    var ymin = image.height;
    var xmax = 0;
    var ymax = 0;

    for (var j=0; j<feature.corners.length; j++) {
      xmin = Math.min(xmin, feature.corners[j].x);
      ymin = Math.min(ymin, feature.corners[j].y);
      xmax = Math.max(xmax, feature.corners[j].x);
      ymax = Math.max(ymax, feature.corners[j].y);
    }
    
    xmin = Math.max(xmin - padding, 0);
    ymin = Math.max(ymin - padding, 0);
    xmax = Math.min(xmax + padding, image.width);
    ymax = Math.min(ymax + padding, image.height);
    
    return [{x: xmin, y: ymin},{x: xmax, y: ymax}];
  }

  function markFeature(canvas, feature) {
    var context = canvas.getContext('2d');
    var corner = feature.corners[0];
    
    context.beginPath();
    context.moveTo(corner.x, corner.y);
    
    for (var j=feature.corners.length - 1; j>=0; j--) {
      corner = feature.corners[j];
      context.lineTo(corner.x, corner.y);
    }

    context.lineWidth = 0.5;
    context.stroke();
  }

  window.onload = function() {
    $.getJSON('ptolemy_britain_features.js', function(data) {
      var mapCanvas = document.getElementById('map');
      var mapContext = mapCanvas.getContext('2d');
      mapContext.set

      // Crop & rotate image on load
      image.onload = function() {
        mapCanvas.width = image.width;
        mapCanvas.height = image.height;
        mapContext.drawImage(image, 0, 0);
				
        
        for(var i=0; i<data.length; i++) {				
          markFeature(mapCanvas, data[i]);
        }
      }
      
      image.src = '../images/british_isles.jpg';
			
      // Add links to the map
      var inside;
      var hovered = -1;
      var clicked = -1;

      mapCanvas.addEventListener("mousemove", function(event) {
        var cursor = "";
        hovered = -1;
        
        for (var i=0; i<data.length; i++) {
          var feature = data[i];
          var bbox = getBoundingBox(feature, 0);
					
          var x = event.clientX - mapCanvas.offsetLeft;
          var y = event.clientY - mapCanvas.offsetTop;
					
          if (x>=bbox[0].x && x<=bbox[1].x && y>=bbox[0].y && y<=bbox[1].y) {
            cursor = "pointer";
            hovered = i;
          }
        }

        document.body.style.cursor = cursor;

        if (hovered != -1) {
          if (!window.popup || window.popup.hovered != hovered) {
            if (window.popup) {
              document.body.removeChild(window.popup);
              delete window.popup;
            }           

            window.popup = openPopup({x: event.clientX, y: event.clientY}, data[hovered]);
            window.popup.hovered = hovered;
          }

          window.popup.style.left = (event.clientX + 5) + 'px';
          window.popup.style.top = (event.clientY + 5) + 'px';
        } else {
          document.body.removeChild(window.popup);
          delete window.popup;
        }
      }, false);
    });
  }
  </script>
  </head>

  <body style="padding:10px">
    <canvas id="map"></canvas>
  </body>
</html>

